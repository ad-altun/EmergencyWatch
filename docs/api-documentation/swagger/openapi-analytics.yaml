openapi: 3.1.0
info:
  title: EmergencyWatch Analytics API
  description: |
    Real-time fleet analytics and historical metrics for emergency vehicles.
    
    This service provides:
    - Fleet-wide metrics (average speed, fuel consumption, vehicle counts)
    - Per-vehicle analytics with status distribution
    - Historical metrics from DB aggregations
  version: 1.0.0
  contact:
    name: Deniz Altun
    url: https://denizaltun.de

servers:
  - url: http://localhost:8082
    description: Local development server
  - url: https://emergencywatch.denizaltun.de
    description: Custom Azure API Management gateway
  - url: https://emergencywatch-api.denizaltun.de
    description: Azure API Management gateway
    variables:
      apim-instance:
        default: emergencywatch-apim
        description: Your Azure APIM instance name

tags:
  - name: Fleet Analytics
    description: Fleet-wide metrics and statistics
  - name: Vehicle Analytics
    description: Individual vehicle metrics
  - name: Historical Data
    description: Aggregated historical metrics from DB
  - name: Admin
    description: Administrative operations
  - name: Health
    description: Health and readiness probes

paths:
  /api/analytics/fleet:
    get:
      summary: Get fleet analytics
      description: Returns fleet-wide metrics including total vehicles, average speed, and fuel consumption
      tags:
        - Fleet Analytics
      responses:
        "200":
          description: Successfully retrieved fleet metrics
          content:
            application/json:
              schema:
                $ref: "#/components/schemas/FleetAnalyticsResponse"
              example:
                totalVehicles: 5
                totalTelemetryReceived: 1250
                fleetAverageSpeed: 45.5
                totalFuelConsumed: 890.25
                vehiclesByType:
                  FIRE_TRUCK: 2
                  AMBULANCE: 2
                  POLICE: 1
                averageSpeedByType:
                  FIRE_TRUCK: 42.3
                  AMBULANCE: 48.7
                  POLICE: 55.2

  /api/analytics/vehicles:
    get:
      summary: Get all vehicle analytics
      description: Returns analytics for all tracked vehicles
      tags:
        - Vehicle Analytics
      responses:
        "200":
          description: Successfully retrieved all vehicle metrics
          content:
            application/json:
              schema:
                type: array
                items:
                  $ref: "#/components/schemas/VehicleAnalyticsResponse"

  /api/analytics/vehicles/{vehicleId}:
    get:
      summary: Get vehicle analytics
      description: Returns analytics for a specific vehicle
      tags:
        - Vehicle Analytics
      parameters:
        - name: vehicleId
          in: path
          required: true
          description: Unique vehicle identifier
          schema:
            type: string
          example: FIRE-001
      responses:
        "200":
          description: Successfully retrieved vehicle metrics
          content:
            application/json:
              schema:
                $ref: "#/components/schemas/VehicleAnalyticsResponse"
        "404":
          $ref: "#/components/responses/NotFound"
        "500":
          $ref: "#/components/responses/InternalServerError"

  /api/analytics/vehicles/type/{type}:
    get:
      summary: Get analytics by vehicle type
      description: Returns analytics for all vehicles of a specific type
      tags:
        - Vehicle Analytics
      parameters:
        - name: type
          in: path
          required: true
          description: Vehicle type
          schema:
            $ref: "#/components/schemas/VehicleType"
          example: FIRE_TRUCK
      responses:
        "200":
          description: Successfully retrieved vehicle metrics by type
          content:
            application/json:
              schema:
                type: array
                items:
                  $ref: "#/components/schemas/VehicleAnalyticsResponse"

  /api/analytics/stats:
    get:
      summary: Get quick stats
      description: Returns a quick overview of analytics statistics
      tags:
        - Fleet Analytics
      responses:
        "200":
          description: Successfully retrieved stats
          content:
            application/json:
              schema:
                type: object
                properties:
                  trackedVehicles:
                    type: integer
                    example: 5
                  totalTelemetry:
                    type: integer
                    example: 1250
                  fleetAverageSpeed:
                    type: string
                    example: "45.50 km/h"

  /api/analytics/history:
    get:
      summary: Get historical metrics
      description: Retrieve aggregated metrics from DB for a date range
      tags:
        - Historical Data
      parameters:
        - name: from
          in: query
          required: true
          description: Start date (ISO format)
          schema:
            type: string
            format: date
          example: "2026-01-06"
        - name: to
          in: query
          required: true
          description: End date (ISO format)
          schema:
            type: string
            format: date
          example: "2026-01-13"
      responses:
        "200":
          description: Successfully retrieved historical metrics
          content:
            application/json:
              schema:
                $ref: "#/components/schemas/HistoricalMetricsResponse"
        "400":
          $ref: "#/components/responses/BadRequest"
        "500":
          $ref: "#/components/responses/InternalServerError"

  /api/analytics/admin/aggregate/{date}:
    post:
      summary: Trigger manual aggregation
      description: Admin endpoint to manually trigger daily metrics aggregation for a specific date
      tags:
        - Admin
      parameters:
        - name: date
          in: path
          required: true
          description: Date to aggregate (ISO format)
          schema:
            type: string
            format: date
          example: "2026-01-13"
      responses:
        "200":
          description: Aggregation triggered successfully
          content:
            text/plain:
              schema:
                type: string
              example: "Aggregation triggered for 2026-01-13"

  /api/analytics/telemetry/latest:
    get:
      summary: Get latest telemetry per vehicle
      description: Returns the most recent telemetry record for each vehicle
      tags:
        - Vehicle Analytics
      responses:
        "200":
          description: Successfully retrieved latest telemetry for all vehicles
          content:
            application/json:
              schema:
                type: array
                items:
                  $ref: "#/components/schemas/VehicleTelemetry"
        "500":
          $ref: "#/components/responses/InternalServerError"

  /actuator/health:
    get:
      summary: Health check endpoint
      description: Returns the health status of the service
      tags:
        - Health
      responses:
        "200":
          description: Service is healthy
          content:
            application/json:
              schema:
                type: object
                properties:
                  status:
                    type: string
                    example: UP
        "503":
          description: Service is unhealthy
          content:
            application/json:
              schema:
                type: object
                properties:
                  status:
                    type: string
                    example: DOWN

  /actuator/health/readiness:
    get:
      summary: Readiness probe
      description: Kubernetes readiness probe endpoint
      tags:
        - Health
      responses:
        "200":
          description: Service is ready to accept traffic
          content:
            application/json:
              schema:
                type: object
                properties:
                  status:
                    type: string
                    example: UP
        "503":
          description: Service is not ready
          content:
            application/json:
              schema:
                type: object
                properties:
                  status:
                    type: string
                    example: DOWN

  /actuator/health/liveness:
    get:
      summary: Liveness probe
      description: Kubernetes liveness probe endpoint
      tags:
        - Health
      responses:
        "200":
          description: Service is alive
          content:
            application/json:
              schema:
                type: object
                properties:
                  status:
                    type: string
                    example: UP
        "503":
          description: Service is not alive
          content:
            application/json:
              schema:
                type: object
                properties:
                  status:
                    type: string
                    example: DOWN

components:
  schemas:
    VehicleType:
      type: string
      enum:
        - FIRE_TRUCK
        - AMBULANCE
        - POLICE
      description: Type of emergency vehicle

    VehicleStatus:
      type: string
      enum:
        - IDLE
        - EN_ROUTE
        - ON_SCENE
        - RETURNING
      description: Current operational status of vehicle

    FleetAnalyticsResponse:
      type: object
      properties:
        totalVehicles:
          type: integer
          description: Total number of tracked vehicles
        totalTelemetryReceived:
          type: integer
          description: Total telemetry messages received
        fleetAverageSpeed:
          type: number
          format: double
          description: Average speed across all vehicles (km/h)
        totalFuelConsumed:
          type: number
          format: double
          description: Total fuel consumed across fleet (liters)
        vehiclesByType:
          type: object
          additionalProperties:
            type: integer
          description: Count of vehicles by type
        averageSpeedByType:
          type: object
          additionalProperties:
            type: number
          description: Average speed by vehicle type
        currentStatusOverview:
          type: object
          additionalProperties:
            type: integer
          description: Count of vehicles by current status

    VehicleAnalyticsResponse:
      type: object
      properties:
        vehicleId:
          type: string
          description: Unique vehicle identifier
          example: FIRE-001
        vehicleType:
          $ref: "#/components/schemas/VehicleType"
        vehicleStatus:
          $ref: "#/components/schemas/VehicleStatus"
        averageSpeed:
          type: number
          format: double
          description: Average speed (km/h)
        totalFuelConsumed:
          type: number
          format: double
          description: Total fuel consumed (liters)
        telemetryCount:
          type: integer
          description: Number of telemetry messages received
        statusDistribution:
          type: object
          additionalProperties:
            type: integer
          description: Time spent in each status
        firstSeen:
          type: string
          format: date-time
          description: First telemetry timestamp
        lastSeen:
          type: string
          format: date-time
          description: Most recent telemetry timestamp

    HistoricalMetricsResponse:
      type: object
      properties:
        fromDate:
          type: string
          format: date
          description: Start date of the range
          example: "2026-01-06"
        toDate:
          type: string
          format: date
          description: End date of the range
          example: "2026-01-13"
        totalDays:
          type: integer
          description: Total number of days in the date range (inclusive)
          example: 8
        daysWithData:
          type: integer
          description: Number of days that have actual data in the database
          example: 2
        averageFleetSpeed:
          type: number
          format: double
          description: Average fleet speed across all days with data (km/h)
          example: 45.5
        totalFuelConsumed:
          type: number
          format: double
          description: Total fuel consumed across all days (liters)
          example: 890.25
        totalDataPoints:
          type: integer
          description: Total number of telemetry data points
          example: 1250
        dailyFleetMetrics:
          type: array
          items:
            $ref: "#/components/schemas/DailyFleetMetrics"
          description: Daily aggregated fleet metrics (includes empty entries for missing dates)
        dailyVehicleMetrics:
          type: array
          items:
            $ref: "#/components/schemas/DailyVehicleMetrics"
          description: Daily per-vehicle metrics
        vehicleFuelConsumption:
          type: array
          items:
            $ref: "#/components/schemas/VehicleFuelConsumption"
          description: Total fuel consumption per vehicle for the date range

    DailyFleetMetrics:
      type: object
      properties:
        id:
          type: string
          description: Unique identifier
        date:
          type: string
          format: date
          description: Date of the metrics
          example: "2026-01-13"
        totalVehicles:
          type: integer
          description: Number of vehicles tracked on this date
          example: 5
        fleetAverageSpeed:
          type: number
          format: double
          nullable: true
          description: Average speed across all vehicles (km/h), null if no data
          example: 45.5
        totalFuelConsumed:
          type: number
          format: double
          nullable: true
          description: Total fuel consumed (liters), null if no data
          example: 125.5
        averageSpeedByStatus:
          type: object
          additionalProperties:
            type: number
          description: Average speed grouped by vehicle status
          example:
            IDLE: 0.0
            EN_ROUTE: 65.5
            ON_SCENE: 5.2
            RETURNING: 55.0
        averageSpeedByType:
          type: object
          additionalProperties:
            type: number
          description: Average speed grouped by vehicle type
          example:
            FIRE_TRUCK: 42.3
            AMBULANCE: 48.7
            POLICE: 55.2

    DailyVehicleMetrics:
      type: object
      properties:
        id:
          type: string
          description: Unique identifier
        vehicleId:
          type: string
          description: Vehicle identifier
          example: "FIRE-001"
        date:
          type: string
          format: date
          description: Date of the metrics
          example: "2026-01-13"
        vehicleStatus:
          $ref: "#/components/schemas/VehicleStatus"
        vehicleType:
          $ref: "#/components/schemas/VehicleType"
        averageSpeed:
          type: number
          format: double
          description: Average speed for this vehicle on this date (km/h)
          example: 42.5
        maxSpeed:
          type: number
          format: double
          description: Maximum speed recorded (km/h)
          example: 85.0
        minSpeed:
          type: number
          format: double
          description: Minimum speed recorded (km/h)
          example: 0.0
        averageFuelLevel:
          type: number
          format: double
          description: Average fuel level percentage (0-100)
          example: 65.5
        minFuelLevel:
          type: number
          format: double
          description: Minimum fuel level percentage (0-100)
          example: 45.0
        fuelConsumed:
          type: number
          format: double
          nullable: true
          description: Estimated fuel consumed on this date (liters)
          example: 25.5
        totalTelemetryPoints:
          type: integer
          description: Number of telemetry data points for this vehicle on this date
          example: 250

    VehicleFuelConsumption:
      type: object
      description: Total fuel consumption for a vehicle over the date range
      properties:
        vehicleId:
          type: string
          description: Vehicle identifier
          example: "FIRE-001"
        vehicleType:
          type: string
          description: Type of vehicle
          example: "FIRE_TRUCK"
        totalConsumed:
          type: number
          format: double
          description: Total fuel consumed over the date range (liters)
          example: 125.5

    VehicleTelemetry:
      type: object
      description: Real-time telemetry data from a vehicle
      properties:
        id:
          type: integer
          format: int64
          description: Unique telemetry record ID
        vehicleId:
          type: string
          description: Vehicle identifier
          example: FIRE-001
        vehicleType:
          $ref: "#/components/schemas/VehicleType"
        vehicleStatus:
          $ref: "#/components/schemas/VehicleStatus"
        timeStamp:
          type: string
          format: date-time
          description: When the telemetry was recorded
        latitude:
          type: number
          format: double
          description: GPS latitude
          example: 52.5200
        longitude:
          type: number
          format: double
          description: GPS longitude
          example: 13.4050
        speed:
          type: number
          format: double
          description: Current speed in km/h
          example: 45.5
        fuelLevel:
          type: number
          format: double
          description: Fuel level percentage (0-100)
          example: 75.5
        engineTemp:
          type: number
          format: double
          description: Engine temperature in Celsius
          example: 85.0
        batteryVoltage:
          type: number
          format: double
          description: Battery voltage
          example: 12.8
        emergencyLightsActive:
          type: boolean
          description: Whether emergency lights are on
          example: false
        createdAt:
          type: string
          format: date-time
          description: When the record was created in the database

  responses:
    BadRequest:
      description: Bad request - invalid parameters
      content:
        application/json:
          schema:
            type: object
            properties:
              timestamp:
                type: string
                format: date-time
              status:
                type: integer
                example: 400
              error:
                type: string
                example: Bad Request
              message:
                type: string
              path:
                type: string

    NotFound:
      description: Resource not found
      content:
        application/json:
          schema:
            type: object
            properties:
              timestamp:
                type: string
                format: date-time
              status:
                type: integer
                example: 404
              error:
                type: string
                example: Not Found
              message:
                type: string
              path:
                type: string

    InternalServerError:
      description: Internal server error
      content:
        application/json:
          schema:
            type: object
            properties:
              timestamp:
                type: string
                format: date-time
              status:
                type: integer
                example: 500
              error:
                type: string
                example: Internal Server Error
              message:
                type: string
              path:
                type: string

  securitySchemes:
    ApiKeyAuth:
      type: apiKey
      in: header
      name: Ocp-Apim-Subscription-Key
      description: Azure API Management subscription key

    BearerAuth:
      type: http
      scheme: bearer
      bearerFormat: JWT
      description: JWT token authentication (optional for future use)