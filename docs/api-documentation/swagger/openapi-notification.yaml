openapi: 3.1.0
info:
  title: EmergencyWatch Notification API
  description: |
    Alert management and notification system for emergency vehicle fleet.
    
    This service provides:
    - Alert lifecycle management (ACTIVE → ACKNOWLEDGED → RESOLVED)
    - Alert deduplication to prevent duplicate active alerts
    - Filtering by vehicle ID, vehicle type, and status
  version: 1.0.0
  contact:
    name: Deniz Altun
    url: https://denizaltun.de

servers:
  - url: http://localhost:8083
    description: Local development server
  - url: https://emergencywatch-api.denizaltun.de
    description: Custom API Management gateway
  - url: https://{apim-instance}.azure-api.net
    description: Azure API Management gateway
    variables:
      apim-instance:
        default: emergencywatch-apim

tags:
  - name: Alerts
    description: Alert management and queries
  - name: Health
    description: Health and readiness probes

paths:
  /api/alerts:
    get:
      summary: Get all alerts
      description: Returns all alerts regardless of status
      tags:
        - Alerts
      responses:
        "200":
          description: List of all alerts
          content:
            application/json:
              schema:
                type: array
                items:
                  $ref: "#/components/schemas/Alert"

  /api/alerts/active:
    get:
      summary: Get active alerts
      description: Returns only alerts with ACTIVE status
      tags:
        - Alerts
      responses:
        "200":
          description: List of active alerts
          content:
            application/json:
              schema:
                type: array
                items:
                  $ref: "#/components/schemas/Alert"

  /api/alerts/vehicle/{vehicleId}:
    get:
      summary: Get alerts by vehicle
      description: Returns all alerts for a specific vehicle
      tags:
        - Alerts
      parameters:
        - name: vehicleId
          in: path
          required: true
          description: Vehicle identifier
          schema:
            type: string
          example: AMBULANCE-002
      responses:
        "200":
          description: List of alerts for the vehicle
          content:
            application/json:
              schema:
                type: array
                items:
                  $ref: "#/components/schemas/Alert"

  /api/alerts/vehicle/type/{vehicleType}:
    get:
      summary: Get alerts by vehicle type
      description: Returns all alerts for vehicles of a specific type
      tags:
        - Alerts
      parameters:
        - name: vehicleType
          in: path
          required: true
          description: Vehicle type
          schema:
            $ref: "#/components/schemas/VehicleType"
          example: FIRE_TRUCK
      responses:
        "200":
          description: List of alerts for the vehicle type
          content:
            application/json:
              schema:
                type: array
                items:
                  $ref: "#/components/schemas/Alert"

  /api/alerts/stats:
    get:
      summary: Get alert statistics
      description: Returns summary statistics about alerts
      tags:
        - Alerts
      responses:
        "200":
          description: Alert statistics
          content:
            application/json:
              schema:
                type: object
                properties:
                  activeAlerts:
                    type: integer
                    description: Number of currently active alerts
                    example: 3
                  totalAlerts:
                    type: integer
                    description: Total number of alerts
                    example: 15

  /api/alerts/{id}/acknowledge:
    patch:
      summary: Acknowledge an alert
      description: Changes alert status from ACTIVE to ACKNOWLEDGED
      tags:
        - Alerts
      parameters:
        - name: id
          in: path
          required: true
          description: Alert ID
          schema:
            type: integer
            format: int64
          example: 1
      responses:
        "200":
          description: Alert acknowledged successfully
          content:
            application/json:
              schema:
                $ref: "#/components/schemas/Alert"
        "404":
          $ref: "#/components/responses/NotFound"
        "500":
          $ref: "#/components/responses/InternalServerError"

  /api/alerts/{id}/resolve:
    patch:
      summary: Resolve an alert
      description: Changes alert status to RESOLVED
      tags:
        - Alerts
      parameters:
        - name: id
          in: path
          required: true
          description: Alert ID
          schema:
            type: integer
            format: int64
          example: 1
      responses:
        "200":
          description: Alert resolved successfully
          content:
            application/json:
              schema:
                $ref: "#/components/schemas/Alert"
        "404":
          $ref: "#/components/responses/NotFound"
        "500":
          $ref: "#/components/responses/InternalServerError"

  /actuator/health:
    get:
      summary: Health check endpoint
      description: Returns the health status of the service
      tags:
        - Health
      responses:
        "200":
          description: Service is healthy
          content:
            application/json:
              schema:
                type: object
                properties:
                  status:
                    type: string
                    example: UP
        "503":
          description: Service is unhealthy
          content:
            application/json:
              schema:
                type: object
                properties:
                  status:
                    type: string
                    example: DOWN

  /actuator/health/readiness:
    get:
      summary: Readiness probe
      description: Kubernetes readiness probe endpoint
      tags:
        - Health
      responses:
        "200":
          description: Service is ready to accept traffic
          content:
            application/json:
              schema:
                type: object
                properties:
                  status:
                    type: string
                    example: UP
        "503":
          description: Service is not ready
          content:
            application/json:
              schema:
                type: object
                properties:
                  status:
                    type: string
                    example: DOWN

  /actuator/health/liveness:
    get:
      summary: Liveness probe
      description: Kubernetes liveness probe endpoint
      tags:
        - Health
      responses:
        "200":
          description: Service is alive
          content:
            application/json:
              schema:
                type: object
                properties:
                  status:
                    type: string
                    example: UP
        "503":
          description: Service is not alive
          content:
            application/json:
              schema:
                type: object
                properties:
                  status:
                    type: string
                    example: DOWN

components:
  schemas:
    VehicleType:
      type: string
      enum:
        - FIRE_TRUCK
        - AMBULANCE
        - POLICE
      description: Type of emergency vehicle

    AlertType:
      type: string
      enum:
        - LOW_FUEL
        - HIGH_ENGINE_TEMP
        - LOW_BATTERY
        - VEHICLE_IDLE_TOO_LONG
        - EMERGENCY_STATUS_CHANGE
      description: Type of alert condition

    AlertStatus:
      type: string
      enum:
        - ACTIVE
        - ACKNOWLEDGED
        - RESOLVED
      description: Current status of the alert

    Alert:
      type: object
      properties:
        id:
          type: integer
          format: int64
          description: Unique alert identifier
          example: 1
        vehicleId:
          type: string
          description: Vehicle that triggered the alert
          example: FIRE-001
        vehicleType:
          $ref: "#/components/schemas/VehicleType"
        alertType:
          $ref: "#/components/schemas/AlertType"
        message:
          type: string
          description: Human-readable alert message
          example: "Low fuel level: 15.5%"
        status:
          $ref: "#/components/schemas/AlertStatus"
        threshold:
          type: string
          description: Threshold that was exceeded
          example: "20%"
        actualValue:
          type: string
          description: Actual value that triggered the alert
          example: "15.5%"
        createdAt:
          type: string
          format: date-time
          description: When the alert was created
        acknowledgedAt:
          type: string
          format: date-time
          description: When the alert was acknowledged (if applicable)
        resolvedAt:
          type: string
          format: date-time
          description: When the alert was resolved (if applicable)
      required:
        - vehicleId
        - vehicleType
        - alertType
        - message
        - status
        - createdAt

  responses:
    BadRequest:
      description: Bad request - invalid parameters
      content:
        application/json:
          schema:
            type: object
            properties:
              timestamp:
                type: string
                format: date-time
              status:
                type: integer
                example: 400
              error:
                type: string
                example: Bad Request
              message:
                type: string
              path:
                type: string

    NotFound:
      description: Resource not found
      content:
        application/json:
          schema:
            type: object
            properties:
              timestamp:
                type: string
                format: date-time
              status:
                type: integer
                example: 404
              error:
                type: string
                example: Not Found
              message:
                type: string
              path:
                type: string

    InternalServerError:
      description: Internal server error
      content:
        application/json:
          schema:
            type: object
            properties:
              timestamp:
                type: string
                format: date-time
              status:
                type: integer
                example: 500
              error:
                type: string
                example: Internal Server Error
              message:
                type: string
              path:
                type: string

  securitySchemes:
    ApiKeyAuth:
      type: apiKey
      in: header
      name: Ocp-Apim-Subscription-Key
      description: Azure API Management subscription key

    BearerAuth:
      type: http
      scheme: bearer
      bearerFormat: JWT
      description: JWT token authentication (optional for future use)